{% extends "base.html" %}

{% block title %}NKP Cluster Cleaner - Scheduled Tasks{% endblock %}

{% block header_title %}Scheduled Tasks{% endblock %}
{% block header_subtitle %}CronJob status and execution history{% endblock %}

{% block extra_css %}
<style>
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .summary-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        text-align: center;
        border-left: 4px solid #667eea;
    }
    .summary-number {
        font-size: 2em;
        font-weight: bold;
        margin-bottom: 5px;
    }
    .summary-label {
        color: #718096;
        font-size: 0.9em;
        font-weight: 500;
    }
    .cronjob-section, .jobs-section {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    .cronjob-table, .jobs-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }
    .cronjob-table th, .jobs-table th {
        background: linear-gradient(#1a202c 0%, #404e66 100%);
        color: white;
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        border-right: 1px solid #404e66;
        border-bottom: 1px solid #2d3748;
    }
    .cronjob-table td, .jobs-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
        vertical-align: top;
    }
    .cronjob-table tr:hover, .jobs-table tr:hover {
        background-color: #f8f9fa;
    }
    .cronjob-table tr:last-child td, .jobs-table tr:last-child td {
        border-bottom: none;
    }
    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.85em;
        font-weight: 500;
        display: inline-block;
    }
    .badge-active {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .badge-suspended {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    .badge-succeeded {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .badge-failed {
        background-color: #ffe6e6;
        color: #d32f2f;
        border: 1px solid #ffcdd2;
    }
    .badge-running {
        background-color: #e3f2fd;
        color: #1565c0;
        border: 1px solid #bbdefb;
    }
    .badge-pending {
        background-color: #f3e5f5;
        color: #7b1fa2;
        border: 1px solid #e1bee7;
    }
    .schedule-info {
        font-family: 'Courier New', monospace;
        background-color: #f8f9fa;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.9em;
    }
    .time-info {
        color: #6c757d;
        font-size: 0.9em;
    }
    .logs-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    .logs-content {
        background-color: white;
        margin: 5% auto;
        padding: 20px;
        border-radius: 10px;
        width: 90%;
        max-width: 1000px;
        max-height: 80vh;
        overflow-y: auto;
    }
    .logs-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e2e8f0;
    }
    .logs-close {
        background: #e53e3e;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
    }
    .logs-close:hover {
        background: #c53030;
    }
    .logs-pre {
        background: #1a202c;
        color: #e2e8f0;
        padding: 20px;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        white-space: pre-wrap;
        max-height: 500px;
        overflow-y: auto;
        line-height: 1.4;
    }
    .view-logs-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8em;
    }
    .view-logs-btn:hover {
        background: #5a67d8;
    }
    .view-logs-btn:disabled {
        background: #a0aec0;
        cursor: not-allowed;
    }
    .trigger-btn {
        background: #48bb78;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8em;
        margin-left: 5px;
    }
    .trigger-btn:hover {
        background: #38a169;
    }
    .trigger-btn:disabled {
        background: #a0aec0;
        cursor: not-allowed;
    }
    .success-message {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        border-left: 4px solid #28a745;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        color: #155724;
    }
    .error-message {
        background-color: #ffe6e6;
        border: 1px solid #ffcdd2;
        border-left: 4px solid #f44336;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        color: #d32f2f;
    }
    .refresh-info {
        background-color: #f0f8ff;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #2196f3;
        border-left: 4px solid #2196f3;
    }
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #666;
    }
    .empty-state .icon {
        font-size: 4em;
        margin-bottom: 16px;
        opacity: 0.5;
    }
    .error-state {
        background-color: #ffebee;
        border: 1px solid #f44336;
        border-left: 4px solid #f44336;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }
    .job-details {
        font-size: 0.9em;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
    {% if error %}
        <div class="error-state">
            <h3>‚ùå Error Loading Scheduled Tasks</h3>
            <p><strong>Error:</strong> {{ error }}</p>
            <p>Please check your kubeconfig and ensure the cluster is accessible.</p>
            <a href="/scheduled-tasks" onclick="location.reload()">üîÑ Try Again</a>
        </div>
    {% else %}
        <div class="refresh-info">
            <strong>üìä Scheduled Tasks Status Report</strong>
            <p>Data refreshed at: <strong>{{ refresh_time }}</strong></p>
            <p>Namespace: <strong>{{ namespace }}</strong></p>
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="summary-card">
                <div class="summary-number">{{ summary.total_cronjobs }}</div>
                <div class="summary-label">Total CronJobs</div>
            </div>
            <div class="summary-card">
                <div class="summary-number">{{ summary.active_cronjobs }}</div>
                <div class="summary-label">Active</div>
            </div>
            <div class="summary-card">
                <div class="summary-number">{{ summary.suspended_cronjobs }}</div>
                <div class="summary-label">Suspended</div>
            </div>
            <div class="summary-card">
                <div class="summary-number">{{ summary.successful_jobs }}</div>
                <div class="summary-label">Recent Successes</div>
            </div>
            <div class="summary-card">
                <div class="summary-number">{{ summary.failed_jobs }}</div>
                <div class="summary-label">Recent Failures</div>
            </div>
            <div class="summary-card">
                <div class="summary-number">{{ summary.running_jobs }}</div>
                <div class="summary-label">Currently Running</div>
            </div>
        </div>

        <!-- CronJobs Section -->
        <div class="cronjob-section">
            <h2>üìÖ CronJobs</h2>
            {% if summary.cronjobs %}
                <table class="cronjob-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Schedule</th>
                            <th>Status</th>
                            <th>Last Run</th>
                            <th>Active Jobs</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cronjob in summary.cronjobs %}
                        <tr>
                            <td><strong>{{ cronjob.name }}</strong></td>
                            <td><span class="schedule-info">{{ cronjob.schedule }}</span></td>
                            <td>
                                {% if cronjob.suspend %}
                                    <span class="status-badge badge-suspended">Suspended</span>
                                {% else %}
                                    <span class="status-badge badge-active">Active</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if cronjob.last_schedule_time %}
                                    <span class="time-info">{{ cronjob.last_schedule_time.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                                {% else %}
                                    <span class="time-info">Never</span>
                                {% endif %}
                            </td>
                            <td>{{ cronjob.active_jobs }}</td>
                            <td><span class="time-info">{{ cronjob.creation_timestamp.strftime('%Y-%m-%d') }}</span></td>
                            <td>
                                {% if 'delete' in cronjob.name %}
                                    <button class="trigger-btn" onclick="showDeleteConfirmation('{{ cronjob.name }}', '{{ cronjob.namespace }}')">
                                        Trigger Now
                                    </button>
                                {% else %}
                                    <button class="trigger-btn" onclick="triggerCronJob('{{ cronjob.name }}', '{{ cronjob.namespace }}')">
                                        Trigger Now
                                    </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="empty-state">
                    <div class="icon">üìÖ</div>
                    <h3>No CronJobs Found</h3>
                    <p>No CronJobs with label "app=nkp-cluster-cleaner" found in the {{ namespace }} namespace.</p>
                </div>
            {% endif %}
        </div>

        <!-- Recent Jobs Section -->
        <div class="jobs-section">
            <h2>üîÑ Recent Job Executions</h2>
            {% if summary.recent_jobs %}
                <table class="jobs-table">
                    <thead>
                        <tr>
                            <th>Job Name</th>
                            <th>CronJob</th>
                            <th>Status</th>
                            <th>Start Time</th>
                            <th>Duration</th>
                            <th>Pods</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for job in summary.recent_jobs %}
                        <tr>
                            <td><strong>{{ job.name }}</strong></td>
                            <td>{{ job.cronjob_name }}</td>
                            <td>
                                {% if job.status == 'Succeeded' %}
                                    <span class="status-badge badge-succeeded">{{ job.status }}</span>
                                {% elif job.status == 'Failed' %}
                                    <span class="status-badge badge-failed">{{ job.status }}</span>
                                {% elif job.status == 'Running' %}
                                    <span class="status-badge badge-running">{{ job.status }}</span>
                                {% else %}
                                    <span class="status-badge badge-pending">{{ job.status }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if job.start_time %}
                                    <span class="time-info">{{ job.start_time.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                                {% else %}
                                    <span class="time-info">Not started</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if job.duration %}
                                    {{ job.duration }}
                                {% else %}
                                    <span class="time-info">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="job-details">
                                    <div>‚úÖ {{ job.succeeded_pods }} succeeded</div>
                                    {% if job.failed_pods > 0 %}
                                        <div>‚ùå {{ job.failed_pods }} failed</div>
                                    {% endif %}
                                    {% if job.active_pods > 0 %}
                                        <div>üîÑ {{ job.active_pods }} running</div>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                {% if job.status in ['Succeeded', 'Failed'] %}
                                    <button class="view-logs-btn" onclick="viewJobLogs('{{ job.name }}', '{{ job.namespace }}')">
                                        View Logs
                                    </button>
                                {% else %}
                                    <button class="view-logs-btn" disabled>
                                        Not Available
                                    </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="empty-state">
                    <div class="icon">üîÑ</div>
                    <h3>No Recent Jobs</h3>
                    <p>No recent job executions found for the configured CronJobs.</p>
                </div>
            {% endif %}
        </div>
    {% endif %}

    <!-- Message display area -->
    <div id="messageArea"></div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="logs-modal">
        <div class="logs-content" style="max-width: 500px;">
            <div class="logs-header">
                <h3>‚ö†Ô∏è Confirm Deletion Job</h3>
            </div>
            <div style="padding: 20px 0;">
                <p><strong>You are about to trigger a cluster deletion job!</strong></p>
                <p>This action may <strong style="color: #d32f2f;">permanently delete clusters</strong> that match the deletion criteria.</p>
                <p><br />Are you sure you want to proceed?</p>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="closeDeleteConfirmModal()" style="background: #48bb78; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; margin-right: 10px;">Cancel</button>
                    <button id="confirmDeleteBtn" class="trigger-btn" style="background: #e53e3e;">Yes, Trigger Delete Job</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs Modal -->
    <div id="logsModal" class="logs-modal">
        <div class="logs-content">
            <div class="logs-header">
                <h3 id="logsTitle">Job Logs</h3>
                <button class="logs-close" onclick="closeLogsModal()">Close</button>
            </div>
            <div id="logsBody">
                <div style="text-align: center; padding: 20px;">Loading logs...</div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    function showDeleteConfirmation(cronjobName, namespace) {
        const modal = document.getElementById('deleteConfirmModal');
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        
        modal.style.display = 'block';
        
        // Set up the confirm button click handler
        confirmBtn.onclick = function() {
            closeDeleteConfirmModal();
            triggerCronJob(cronjobName, namespace);
        };
    }
    
    function closeDeleteConfirmModal() {
        document.getElementById('deleteConfirmModal').style.display = 'none';
    }

    function triggerCronJob(cronjobName, namespace) {
        const messageArea = document.getElementById('messageArea');
        
        // Show loading message
        messageArea.innerHTML = `<div class="refresh-info">‚è≥ Triggering ${cronjobName}...</div>`;
        
        // Disable all trigger buttons temporarily
        const triggerButtons = document.querySelectorAll('.trigger-btn');
        triggerButtons.forEach(btn => btn.disabled = true);
        
        fetch('{{ url_with_prefix('/api/trigger-cronjob') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                cronjob_name: cronjobName,
                namespace: namespace
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                messageArea.innerHTML = `
                    <div class="success-message">
                        <strong>‚úÖ Success!</strong><br>
                        ${data.message}<br>
                        Job Name: <strong>${data.job_name}</strong><br>
                        <small>Triggered at: ${new Date(data.timestamp).toLocaleString()}</small>
                    </div>
                `;
                // Auto-refresh page after 3 seconds to show the new job
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            } else {
                messageArea.innerHTML = `
                    <div class="error-message">
                        <strong>‚ùå Error!</strong><br>
                        ${data.error}<br>
                        <small>Time: ${new Date(data.timestamp).toLocaleString()}</small>
                    </div>
                `;
            }
        })
        .catch(error => {
            messageArea.innerHTML = `
                <div class="error-message">
                    <strong>‚ùå Network Error!</strong><br>
                    ${error.message}
                </div>
            `;
        })
        .finally(() => {
            // Re-enable all trigger buttons
            triggerButtons.forEach(btn => btn.disabled = false);
        });
    }

    function viewJobLogs(jobName, namespace) {
        const modal = document.getElementById('logsModal');
        const title = document.getElementById('logsTitle');
        const body = document.getElementById('logsBody');
        
        title.textContent = `Logs for Job: ${jobName}`;
        body.innerHTML = '<div style="text-align: center; padding: 20px;">Loading logs...</div>';
        modal.style.display = 'block';
        
        // Fetch logs from API endpoint
        fetch(`{{ url_with_prefix('/api/job-logs') }}?job_name=${encodeURIComponent(jobName)}&namespace=${encodeURIComponent(namespace)}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    if (data.logs && data.logs.length > 0) {
                        let logsHtml = '';
                        data.logs.forEach(logEntry => {
                            logsHtml += `
                                <div style="margin-bottom: 20px;">
                                    <h4>Pod: ${logEntry.pod_name}</h4>
                                    <pre class="logs-pre">${logEntry.logs}</pre>
                                </div>
                            `;
                        });
                        body.innerHTML = logsHtml;
                    } else {
                        body.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No logs available for this job.</div>';
                    }
                } else {
                    body.innerHTML = `<div style="text-align: center; padding: 20px; color: #e53e3e;">Error loading logs: ${data.error}</div>`;
                }
            })
            .catch(error => {
                body.innerHTML = `<div style="text-align: center; padding: 20px; color: #e53e3e;">Error loading logs: ${error.message}</div>`;
            });
    }
    
    function closeLogsModal() {
        document.getElementById('logsModal').style.display = 'none';
    }
    
    // Close modal when clicking outside of it
    window.onclick = function(event) {
        const logsModal = document.getElementById('logsModal');
        const deleteModal = document.getElementById('deleteConfirmModal');
        
        if (event.target === logsModal) {
            logsModal.style.display = 'none';
        }
        if (event.target === deleteModal) {
            deleteModal.style.display = 'none';
        }
    }
    
    // Log when data was loaded
    console.log("Scheduled tasks data loaded at: {{ refresh_time }}");
    
    // Auto-refresh page every 30 seconds, but only if no modal is open
    function scheduleRefresh() {
        setTimeout(() => {
            const deleteModal = document.getElementById('deleteConfirmModal');
            const logsModal = document.getElementById('logsModal');
            
            // Only refresh if no modals are open
            if (deleteModal.style.display !== 'block' && logsModal.style.display !== 'block') {
                window.location.reload();
            } else {
                // If modal is open, check again in 5 seconds
                scheduleRefresh();
            }
        }, 30000);
    }
    
    // Start the refresh cycle
    scheduleRefresh();
</script>
{% endblock %}